<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Building incflo with CMake &mdash; incflo 22.04-dev documentation</title>
      <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Building incflo with gmake" href="BuildingGMake.html" />
    <link rel="prev" title="Getting Started" href="GettingStarted.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> incflo
          </a>
              <div class="version">
                22.04-dev
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Introduction.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="GettingStarted.html">Getting Started</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Building incflo with CMake</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#superbuild-instructions-recommended">SUPERBUILD Instructions (recommended)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#standalone-instructions"><strong>STANDALONE</strong> instructions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#building-amrex">Building AMReX</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-incflo">Building incflo</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#few-more-notes-on-building-incflo">Few more notes on building incflo</a></li>
<li class="toctree-l3"><a class="reference internal" href="#building-incflo-for-cori-nersc">Building incflo for Cori (NERSC)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#standard-build">Standard build</a></li>
<li class="toctree-l4"><a class="reference internal" href="#gpu-build">GPU build</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#building-incflo-for-summit-olcf">Building incflo for Summit (OLCF)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="BuildingGMake.html">Building incflo with gmake</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Inputs_Chapter.html">Run-time Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ManagingGridHierarchy_Chapter.html">Gridding and Load Balancing</a></li>
<li class="toctree-l1"><a class="reference internal" href="Fluids_Chapter.html">Solving the Fluid Equations</a></li>
<li class="toctree-l1"><a class="reference internal" href="EB.html">Embedded Boundaries</a></li>
<li class="toctree-l1"><a class="reference internal" href="Debugging.html">Debugging</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">incflo</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="GettingStarted.html">Getting Started</a> &raquo;</li>
      <li>Building incflo with CMake</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/BuildingCMake.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="building-incflo-with-cmake">
<h1>Building incflo with CMake<a class="headerlink" href="#building-incflo-with-cmake" title="Permalink to this headline"></a></h1>
<p>CMake build is a two-steps process. First <code class="docutils literal notranslate"><span class="pre">cmake</span></code> is invoked to create
configuration files and makefiles in a chosen directory (<code class="docutils literal notranslate"><span class="pre">builddir</span></code>).
Next, the actual build is performed by invoking <code class="docutils literal notranslate"><span class="pre">make</span></code> from within <code class="docutils literal notranslate"><span class="pre">builddir</span></code>.
The CMake build process is summarized as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mkdir /path/to/builddir</span>
<span class="go">cd    /path/to/builddir</span>
<span class="go">cmake [options] -DCMAKE_BUILD_TYPE=[Debug|Release|RelWithDebInfo|MinSizeRel] /path/to/incflo</span>
<span class="go">make</span>
</pre></div>
</div>
<p>In the above snippet, <code class="docutils literal notranslate"><span class="pre">[options]</span></code> indicates one or more options for the
customization of the build, as described later in this section.
If the option <code class="docutils literal notranslate"><span class="pre">CMAKE_BUILD_TYPE</span></code> is omitted,
<code class="docutils literal notranslate"><span class="pre">CMAKE_BUILD_TYPE=Release</span></code> is assumed.</p>
<p>There are two modes to build incflo with CMake:</p>
<p>o <strong>SUPERBUILD (recommended):</strong> AMReX is built as part
of the incflo build process. This method is strongly encouraged as it
ensures that the configuration options for incflo and AMReX are consistent.</p>
<p>o <strong>STANDALONE:</strong> incflo source code is built separately and linked to an existing
AMReX installation. This is ideal for continuous integration severs (CI)
and regression testing applications. AMReX library version and configuration options
must meet incflo requirements.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>incflo requires CMake 3.14 or higher.</strong></p>
</div>
<section id="superbuild-instructions-recommended">
<span id="sec-build-superbuild"></span><h2>SUPERBUILD Instructions (recommended)<a class="headerlink" href="#superbuild-instructions-recommended" title="Permalink to this headline"></a></h2>
<p>In this mode, incflo CMake inherents AMReX CMake targets and configuration options, that is, incflo and AMReX are configured and built as a single entity.</p>
<p>First you need to download the AMReX source code as shown in
<a class="reference external" href="https://amrex-codes.github.io/amrex/docs_html/GettingStarted.html">AMReX user guide - Downloading the code</a>.</p>
<p>Next, clone the incflo repository and build the incflo executable:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>&gt; git clone http://github.com/amrex-codees/incflo.git
&gt; <span class="nb">cd</span> incfo
&gt; mkdir build
&gt; <span class="nb">cd</span> build
&gt; cmake -DAMREX_HOME<span class="o">=</span>/path/to/amrex/source/directory <span class="o">[</span>amrex options<span class="o">]</span> -DCMAKE_BUILD_TYPE<span class="o">=[</span>Debug<span class="p">|</span>Release<span class="p">|</span>RelWithDebInfo<span class="p">|</span>MinSizeRel<span class="o">]</span> ..
&gt; make -j
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">AMREX_HOME</span></code> in the snippet above is a CMake variable pointing to the top-level source directory of the AMReX distribution you downloaded earlier.
<code class="docutils literal notranslate"><span class="pre">[amrex</span> <span class="pre">options]</span></code> is a list of any of the AMReX configuration options listed in the
<a class="reference external" href="https://amrex-codes.github.io/amrex/docs_html/BuildingAMReX.html#building-with-cmake">AMReX user guide - Building with CMake</a></p>
</section>
<section id="standalone-instructions">
<span id="sec-build-standalone"></span><h2><strong>STANDALONE</strong> instructions<a class="headerlink" href="#standalone-instructions" title="Permalink to this headline"></a></h2>
<p>If <code class="docutils literal notranslate"><span class="pre">AMREX_HOME</span></code> is not set (see <a class="reference internal" href="#sec-build-superbuild"><span class="std std-ref">SUPERBUILD Instructions (recommended)</span></a>), incflo CMake will look for an existing
AMReX installation on the system and link the incflo binaries against it. .</p>
<section id="building-amrex">
<h3>Building AMReX<a class="headerlink" href="#building-amrex" title="Permalink to this headline"></a></h3>
<p>Clone AMReX from the official Git repository and checkout the
<em>development</em> branch:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>&gt; git clone https://github.com/AMReX-Codes/amrex.git
&gt; <span class="nb">cd</span> amrex
&gt; git checkout development
</pre></div>
</div>
<p>Next, configure, build and install AMReX as follows:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>&gt; mkdir build
&gt; <span class="nb">cd</span> build
&gt; cmake -DCMAKE_BUILD_TYPE<span class="o">=[</span>Debug<span class="p">|</span>Release<span class="p">|</span>RelWithDebInfo<span class="p">|</span>MinSizeRel<span class="o">]</span>  <span class="o">[</span>amrex options<span class="o">]</span> -DCMAKE_INSTALL_PREFIX:PATH<span class="o">=</span>/absolute/path/to/installdir ..
&gt; make install
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">[amrex</span> <span class="pre">options]</span></code> is a list of any of the AMReX configuration options listed in the
<a class="reference external" href="https://amrex-codes.github.io/amrex/docs_html/BuildingAMReX.html#building-with-cmake">AMReX user guide - Building with CMake</a>.
We suggest to always use the option <code class="docutils literal notranslate"><span class="pre">-DUSE_XSDK_DEFAULTS=yes</span></code> when building AMReX for incflo.</p>
</section>
<section id="building-incflo">
<h3>Building incflo<a class="headerlink" href="#building-incflo" title="Permalink to this headline"></a></h3>
<p>Clone and build incflo:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>&gt; git clone https://github.com/amrex-codes/incflo.git
&gt; mkdir build
&gt; <span class="nb">cd</span> build
&gt; cmake -DCMAKE_BUILD_TYPE<span class="o">=[</span>Debug<span class="p">|</span>Release<span class="p">|</span>RelWithDebInfo<span class="p">|</span>MinSizeRel<span class="o">]</span> <span class="o">[</span>incflo options<span class="o">]</span> -DAMReX_ROOT<span class="o">=</span>/absolute/path/to/amrex/installdir ..
&gt; make -j
</pre></div>
</div>
<p>Passing <code class="docutils literal notranslate"><span class="pre">-DAMReX_ROOT=/absolute/path/to/amrex/installdir</span></code> instructs CMake to search
<code class="docutils literal notranslate"><span class="pre">/absolute/path/to/amrex/installdir</span></code> before searching system paths
for an available AMReX installation.
<code class="docutils literal notranslate"><span class="pre">AMReX_ROOT</span></code> can also be set as an environmental variable instead of passing it as a command line option.</p>
<p><code class="docutils literal notranslate"><span class="pre">[incflo</span> <span class="pre">options]</span></code> indicates any of the configuration option listed in the table below.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 22%" />
<col style="width: 38%" />
<col style="width: 23%" />
<col style="width: 17%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Option name</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Possible values</p></th>
<th class="head"><p>Default
value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>CMAKE_CXX_FLAGS</p></td>
<td><p>User-defined C++ flags</p></td>
<td><p>valid C++
compiler flags</p></td>
<td><p>None</p></td>
</tr>
<tr class="row-odd"><td><p>CMAKE_CUDA_FLAGS</p></td>
<td><p>User-defined CUDA flags</p></td>
<td><p>valid CUDA
compiler flags</p></td>
<td><p>None</p></td>
</tr>
<tr class="row-even"><td><p>INCFLO_DIM</p></td>
<td><p>Dimensionality of the build</p></td>
<td><p>2/3</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-odd"><td><p>INCFLO_MPI</p></td>
<td><p>Enable build with MPI</p></td>
<td><p>no/yes</p></td>
<td><p>yes</p></td>
</tr>
<tr class="row-even"><td><p>INCFLO_OMP</p></td>
<td><p>Enable build with OpenMP</p></td>
<td><p>no/yes</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>INCFLO_CUDA</p></td>
<td><p>Enable build with CUDA</p></td>
<td><p>no/yes</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-even"><td><p>INCFLO_EB</p></td>
<td><p>Build Embedded Boundary
support</p></td>
<td><p>no/yes</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>INCFLO_HYPRE</p></td>
<td><p>Enable HYPRE support</p></td>
<td><p>no/yes</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-even"><td><p>INCFLO_FPE</p></td>
<td><p>Build with Floating-Point
Exceptions checks</p></td>
<td><p>no/yes</p></td>
<td><p>no</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="few-more-notes-on-building-incflo">
<h2>Few more notes on building incflo<a class="headerlink" href="#few-more-notes-on-building-incflo" title="Permalink to this headline"></a></h2>
<p>The system default C++ compiler can be overwritten as follows:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>&gt; cmake -DCMAKE_CXX_COMPILER<span class="o">=</span>&lt;c++-compiler&gt;  <span class="o">[</span>options<span class="o">]</span>  ..
</pre></div>
</div>
<p>When building on a platform that uses the <code class="docutils literal notranslate"><span class="pre">module</span></code> utility, use either
the above command (with full path to the compilers) or the following:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>&gt; cmake -DCMAKE_CXX_COMPILER<span class="o">=</span>CC <span class="o">[</span>options<span class="o">]</span> ..
</pre></div>
</div>
<p>incflo uses the same compiler flags used to build AMReX, unless
<code class="docutils literal notranslate"><span class="pre">CMAKE_CXX_FLAGS</span></code> is explicitly provided, or
the environmental variables <code class="docutils literal notranslate"><span class="pre">CXXFLAGS</span></code> is set.</p>
</section>
<section id="building-incflo-for-cori-nersc">
<h2>Building incflo for Cori (NERSC)<a class="headerlink" href="#building-incflo-for-cori-nersc" title="Permalink to this headline"></a></h2>
<section id="standard-build">
<h3>Standard build<a class="headerlink" href="#standard-build" title="Permalink to this headline"></a></h3>
<p>For the Cori cluster at NERSC, you first need to load/unload modules required to build incflo.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>&gt; module unload altd
&gt; module unload darshan
&gt; module load cmake/3.14.0
</pre></div>
</div>
<p>The default options for Cori are the <strong>Haswell</strong> architecture and <strong>Intel</strong> compiler, if you want to compile with the <strong>Knight’s Landing (KNL)</strong> architecture:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>&gt; module swap craype-haswell craype-mic-knl
</pre></div>
</div>
<p>Or use the <strong>GNU</strong> compiler:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>&gt; module swap PrgEnv-intel PrgEnv-gnu
</pre></div>
</div>
<p>Now incflo can be built following the <a class="reference internal" href="#sec-build-superbuild"><span class="std std-ref">SUPERBUILD Instructions (recommended)</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The load/unload modules options could be saved in the <cite>~/.bash_profile.ext</cite></p>
</div>
</section>
<section id="gpu-build">
<h3>GPU build<a class="headerlink" href="#gpu-build" title="Permalink to this headline"></a></h3>
<p>To compile on the GPU nodes in Cori, you first need to purge your modules, most of which won’t work on the GPU nodes</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>&gt; module purge
</pre></div>
</div>
<p>Then, you need to load the following modules:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>&gt; module load modules esslurm gcc cuda openmpi/3.1.0-ucx cmake/3.14.0
</pre></div>
</div>
<p>Currently, you need to use OpenMPI; mvapich2 seems not to work.</p>
<p>Then, you need to use slurm to request access to a GPU node:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>&gt; salloc -N <span class="m">1</span> -t <span class="m">02</span>:00:00 -c <span class="m">80</span> -C gpu -A m1759 --gres<span class="o">=</span>gpu:8 --exclusive
</pre></div>
</div>
<p>This reservers an entire GPU node for your job. Note that you can’t cross-compile for the GPU nodes - you have to log on to one and then build your software.</p>
<p>Finally, navigate to the base of the incflo repository and compile in GPU mode:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>&gt; <span class="nb">cd</span> incflo
&gt; mdkir build
&gt; <span class="nb">cd</span> build
&gt; cmake -DINCFLO_CUDA<span class="o">=</span>yes -DAMReX_CUDA_ARCH<span class="o">=</span>Volta -DCMAKE_CXX_COMPILER<span class="o">=</span>g++ -DCMAKE_Fortran_COMPILER<span class="o">=</span>gfortran ..
&gt; make -j
</pre></div>
</div>
<p>For more information about GPU nodes in Cori – <a class="reference external" href="https://docs-dev.nersc.gov/cgpu/">https://docs-dev.nersc.gov/cgpu/</a></p>
</section>
</section>
<section id="building-incflo-for-summit-olcf">
<h2>Building incflo for Summit (OLCF)<a class="headerlink" href="#building-incflo-for-summit-olcf" title="Permalink to this headline"></a></h2>
<p>For the Summit cluster at OLCF, you first need to load/unload modules required to build incflo.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>&gt; module unload xalt
&gt; module unload darshan
&gt; module load gcc
&gt; module load cmake/3.14.0
</pre></div>
</div>
<p>Now incflo can be built following the <a class="reference internal" href="#sec-build-superbuild"><span class="std std-ref">SUPERBUILD Instructions (recommended)</span></a>.</p>
<p>To build incflo for GPUs, you need to load cuda module:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>&gt; module load cuda/10.1.105
</pre></div>
</div>
<p>To compile for GPUs:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>&gt; <span class="nb">cd</span> incflo
&gt; mdkir build
&gt; <span class="nb">cd</span> build
&gt; cmake -DCMAKE_CXX_COMPILER<span class="o">=</span>g++ -DINCFLO_CUDA<span class="o">=</span>yes
&gt; make -j
</pre></div>
</div>
<p>An example of a <em>submission_script</em> for using the GPUs on Summit can be found in <code class="docutils literal notranslate"><span class="pre">incflo/summit_script.sh</span></code>.
For more information about Summit cluster: <a class="reference external" href="https://www.olcf.ornl.gov/for-users/system-user-guides/summit/">https://www.olcf.ornl.gov/for-users/system-user-guides/summit/</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="GettingStarted.html" class="btn btn-neutral float-left" title="Getting Started" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="BuildingGMake.html" class="btn btn-neutral float-right" title="Building incflo with gmake" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2018, Incflo Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>